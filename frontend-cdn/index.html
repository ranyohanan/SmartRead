<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/lib/marked.umd.min.js"></script>
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="responsive-1000.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&display=swap" rel="stylesheet">
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        function App() {
            const [language, setLanguage] = React.useState('en');
            const [textInput, setTextInput] = React.useState('');
            const [resultMd, setResultMd] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState('');
            const [rawExtracted, setRawExtracted] = React.useState('');
            const [fileExist, setFileExist] = React.useState('');
            const fileRef = React.useRef(null);
            const htmlOutput = resultMd ? marked.parse(resultMd) : '';

            function handleFileChange(event) {
                const file = event.target.files?.[0];
                if (file) {
                    setFileExist(file.name);
                }
                else {
                    setFileExist('');
                }
            }
            async function handleSummarizeText() {
                setError('');
                setResultMd('');
                if (!textInput.trim()) {
                    setError('No text was submitted');
                    return;
                }
                setLoading(true);
                try {
                    const res = await fetch('/summarize', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: textInput, language })
                    });
                    if (!res.ok) {
                        const errText = await res.text();
                        throw new Error(errText || 'Request Failed.');
                    }
                    const data = await res.json();
                    setResultMd(data.markdown);
                } catch (error) {
                    setError(error.message);
                }
                finally {
                    setLoading(false);
                }
            }
            async function handleSummarizeFile() {
                try {
                    setError('');
                    setResultMd('');
                    setRawExtracted('');
                    const file = fileRef.current?.files?.[0];
                    if (!file) {
                        setError('Please choose a file.');
                        return;
                    }
                    setLoading(true);
                    const fd = new FormData();
                    fd.append('file', file);
                    const res1 = await fetch('/ingest/file', { method: 'POST', body: fd });
                    if (!res1.ok) {
                        const errFile = await res1.text();
                        throw new Error(errFile || 'Failed to upload file.');
                    }
                    const data1 = await res1.json();
                    const extracted = data1.text || '';
                    setRawExtracted(extracted);
                    if (!extracted.trim()) {
                        throw new Error('File text extracting has failed.')
                    }
                    const res2 = await fetch('/summarize', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: extracted, language })
                    });
                    if (!res2.ok) {
                        const errText = await res2.text();
                        throw new Error(errText || 'Request Failed.');
                    }
                    const data2 = await res2.json();
                    setResultMd(data2.markdown || '');
                } catch (error) {
                    setError(error.message || 'Network error.');
                }
                finally {
                    setLoading(false);
                }
            }
            return (
                <div>
                    <div id="title-area">
                        <h1>SmartRead</h1>
                        <p>Extract & summarize text or PDFs/DOCX/TXT</p>
                    </div>
                    <div id="language-area">
                        <label htmlFor="language-dropdown">Select language:</label>
                        <select name="language-dropdown" id="language-dropdown" value={language} onChange={(e) => setLanguage(e.target.value)}>
                            <option value="en" lang="en">English</option>
                            <option value="es" lang="es">Español</option>
                            <option value="fr" lang="fr">Français</option>
                            <option value="de" lang="de">Deutsch</option>
                            <option value="ja" lang="ja">日本語</option>
                            <option value="he" lang="he">Hebrew</option>
                            <option value="it" lang="it">Italiano</option>
                        </select></div>
                    <div id="workArea">
                        <div id="textArea">
                            <p id="textAreaP">Put text to summarize: (Max 200k chars)</p>
                            <textarea name="textInput" id="textInput" placeholder="Put your text here" value={textInput} onChange={(e) => setTextInput(e.target.value)}></textarea>
                            <button id="btnSummarizeText" type="button" onClick={handleSummarizeText} disabled={loading}>Summarize text</button>
                        </div>
                        <h3>OR</h3>
                        <div id="fileArea">
                            <p>Upload a file:</p>
                            <p id="fileName">{fileExist}</p>
                            <label htmlFor="fileInput" id="input-label"> Choose file
                                <input type="file" name="fileInput" id="fileInput" accept=".pdf,.docx,.txt,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/plain" ref={fileRef} onChange={handleFileChange} /></label>
                            <button id="btnExtractAndSummarize" type="button" disabled={loading} onClick={handleSummarizeFile}>Summarize file</button>
                        </div>
                    </div>
                    <div id="resultAreaWrapper">
                        {loading && <p id="loading">Working...</p>}
                        {error && <p id="error" style={{ color: 'red' }}>{error}</p>}
                        {
                            resultMd && <div id="result-area">
                                <p>Summarized text:</p>
                                <div
                                    dangerouslySetInnerHTML={{ __html: htmlOutput }}
                                />
                            </div>
                        }</div >
                </div >
            )
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>